name: Deploy to Render

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to Render
    runs-on: ubuntu-latest
    environment:
      name: production
      url: https://quotes-backend.onrender.com

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to Render
        env:
          RENDER_DEPLOY_HOOK_URL: ${{ secrets.RENDER_DEPLOY_HOOK_URL }}
        run: |
          if [ -n "$RENDER_DEPLOY_HOOK_URL" ]; then
            curl -X POST "$RENDER_DEPLOY_HOOK_URL"
            echo "‚úÖ Deployment triggered on Render"
          else
            echo "‚ö†Ô∏è RENDER_DEPLOY_HOOK_URL not set. Skipping deployment."
            echo "To enable auto-deployment:"
            echo "1. Go to your Render service settings"
            echo "2. Copy the Deploy Hook URL"
            echo "3. Add it as RENDER_DEPLOY_HOOK_URL secret in GitHub"
          fi

      - name: Wait for deployment
        run: |
          echo "‚è≥ Waiting for deployment to complete..."
          sleep 60

      - name: Health check
        run: |
          BACKEND_URL="${{ secrets.BACKEND_URL || 'https://quotes-backend.onrender.com' }}"
          echo "üîç Checking health endpoint: $BACKEND_URL/actuator/health"
          
          for i in {1..10}; do
            if curl -f "$BACKEND_URL/actuator/health"; then
              echo "‚úÖ Deployment successful!"
              exit 0
            fi
            echo "‚è≥ Attempt $i/10 failed. Retrying in 10s..."
            sleep 10
          done
          
          echo "‚ùå Deployment verification failed"
          exit 1

      - name: Test API endpoints
        run: |
          BACKEND_URL="${{ secrets.BACKEND_URL || 'https://quotes-backend.onrender.com' }}"
          
          echo "üß™ Testing API endpoints..."
          
          # Test random quote endpoint
          echo "Testing GET /api/quotes/random"
          curl -f "$BACKEND_URL/api/quotes/random" || exit 1
          
          # Test get all quotes endpoint
          echo "Testing GET /api/quotes"
          curl -f "$BACKEND_URL/api/quotes" || exit 1
          
          echo "‚úÖ All API tests passed!"

      - name: Notify success
        if: success()
        run: |
          echo "üéâ Deployment to Render completed successfully!"
          echo "Backend URL: ${{ secrets.BACKEND_URL || 'https://quotes-backend.onrender.com' }}"

      - name: Notify failure
        if: failure()
        run: |
          echo "‚ùå Deployment failed. Check the logs above for details."

